<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="sas.css"/>
        <title>SAS Business Orchestration Worker Configuration</title>
    </head>
    <body>
        <h1 id="140345100038928sas-business-orchestration-worker-configuration">SAS Business Orchestration Worker Configuration</h1>
<h2 id="140345100038928overview">Overview</h2>
<p>This README file describes the configuration settings for a cloud-native engine that enables users to declare their orchestrations through a set of workloads and flows in YAML format. This version of the product is also referred to as SAS Business Orchestration Worker.</p>
<p>SAS Business Orchestration Services has two versions. The first is the one that has been shipping for some time and uses an engine that is based on Apache Camel. The README for deploying and configuring that version of SAS Business Orchestration Services is located at $deploy/sas-bases/examples/sas-boss/README.md (for Markdown format) or at $deploy/sas-bases/docs/deploying_sas_business_orchestration_services.htm (for HTML format).</p>
<h2 id="140345100038928installation">Installation</h2>
<h3 id="140345100038928configure-with-initial-sas-viya-platform-deployment">Configure with Initial SAS Viya Platform Deployment</h3>
<p>Create a copy of the example template in <code>$deploy/sas-bases/examples/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code>. Save this copy in <code>$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code>.</p>
<p>Placeholders are indicated by curly brackets, such as {{ NAMESPACE }}. Find and replace the placeholders with the values you want for your deployment. After all placeholders have been filled in, directly apply your deployment yaml via SAS Viya platform Kustomize or direct kubectl apply commands.</p>
<p>If you are using the SAS Viya platform Kustomize process, add the resource <code>$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code> to the
resources block of the base kustomization.yaml file.  The use case here is to deploy a SAS Business Orchestration Worker project with SAS Viya platform. Here is an example:</p>
<pre class="highlight"><code class="language-yaml">resources:
...
- site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml
...</code></pre>

<h3 id="140345100038928data-in-motion-tls">Data in Motion - TLS</h3>
<p>The <a href="#140345100038928deployment-resource">Deployment Resource</a> sections below describe several TLS configurations for sas-business-orchestration-worker deployments. These configurations must align with SAS Viya security requirements, as specified in SAS Viya Platform Operations guide <a href="https://go.documentation.sas.com/doc/en/itopscdc/default/itopssr/n18dxcft030ccfn1ws2mujww1fav.htm#n0w1os9ufnn7xwn1an3qbhxjxze9">Security Requirements</a>. Here are the specific TLS deployment requirements:</p>
<ul>
<li>&ldquo;No TLS&rdquo; mode can ignore the Deployment Resources TLS sections.</li>
<li>&ldquo;Front-Door TLS&rdquo; mode terminates TLS at the ingress. Therefore, sas-business-orchestration-worker needs an ingress-specific TLS configuration.</li>
<li>&ldquo;Full-Stack TLS&rdquo; mode needs one-way TLS or two-way mTLS configured in addition to the ingress TLS specific configurations. </li>
</ul>
<h3 id="140345100038928deployment-resource">Deployment Resource</h3>
<p>The business-orchestration-worker-deployment.yaml resource has customizable sections.</p>
<h4 id="140345100038928section-config-map">Section - config map</h4>
<p>This section provides a ConfigMap example that mounts the project.yaml into pods. The project.yaml describes the orchestration. </p>
<h4 id="140345100038928section-image-pull-secrets">Section - image pull secrets</h4>
<p>This section provides an image pull secret example that grants access to the container registry images.</p>
<p>The image pull secret can be grepped from the SAS Viya platform Kustomize build command output:</p>
<pre class="highlight"><code class="language-shell">kustomize build . &gt; site.yaml
grep '.dockerconfigjson:' site.yaml
    .dockerconfigjson: &lt;SECRET&gt;</code></pre>

<p>Alternatively, if SAS Viya platform has already been deployed the image pull secret can be queried:</p>
<pre class="highlight"><code class="language-shell">kubectl -n {{ NAMESPACE }} get secret --field-selector=type=kubernetes.io/dockerconfigjson -o yaml | grep '.dockerconfigjson:'
    .dockerconfigjson: &lt;SECRET&gt;</code></pre>

<p>Replace the namespace and image pull secret values in the example.</p>
<h4 id="140345100038928section-service">Section - service</h4>
<p>This section provides an example that configures high availability routing for sas-business-orchestration-worker pods.</p>
<h4 id="140345100038928section-deployment">Section - deployment</h4>
<p>This section provides an example that shows pod configuration and behaviors.</p>
<h5 id="140345100038928configure-the-sas-business-orchestration-worker-init-container">Configure the sas-business-orchestration-worker init Container</h5>
<p>When using ODE processor, you must create a sas-business-orchestration-worker init container that fetches the required SFM jar files from by pulling a docker image. </p>
<ol>
<li>
<p>Create a docker image that contains the required SFM jar files. Here is a sample Dockerfile.</p>
<pre class="highlight"><code class="language-shell">FROM ubuntu

# Package updates and install dependencies
RUN apt-get update -y &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install -y \
    curl \
    apt-transport-https \
    ca-certificates \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# Install kubectl
RUN curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
RUN chmod +x ./kubectl
RUN mv ./kubectl /usr/local/bin

# Grab SAS Fraud Management JARs (boss-worker-sb ode plugin dependency, used in performance/component/processor-ode.yaml)
RUN mkdir /sfmlibs
RUN mkdir /sfmlibs/44
RUN cd /sfmlibs/44 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/f0rapt44/DEVD/ivy-repo/SAS_content/sas.finance.fraud.transaction/404001.0.0.20161020100850_f0rapt44/sas.finance.fraud.transaction.jar
RUN cd /sfmlibs/44 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/f0rapt44/DEVD/ivy-repo/SAS_content/sas.finance.fraud.engine/404001.0.0.20161020100936_f0rapt44/sas.finance.fraud.engine.jar
RUN mkdir /sfmlibs/61
RUN cd /sfmlibs/61 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/f0rapt61/DEVD/ivy-repo/SAS_content/sas.finance.fraud.transaction/601002.0.0.20220622174613_f0rapt61/sas.finance.fraud.transaction.jar
RUN cd /sfmlibs/61 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/f0rapt61/DEVD/ivy-repo/SAS_content/sas.finance.fraud.engine/601002.0.0.20220622174651_f0rapt61/sas.finance.fraud.engine.jar
RUN mkdir /sfmlibs/62
RUN cd /sfmlibs/62 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/d4rapt62/DEVD/ivy-repo/SAS_content/sas.finance.fraud.transaction/602000.0.0.20231003221024_d4rapt62/sas.finance.fraud.transaction.jar
RUN cd /sfmlibs/62 &amp;&amp; curl -LO http://ivy.fyi.sas.com/Repositories/sds/dev/d4rapt62/DEVD/ivy-repo/SAS_content/sas.finance.fraud.engine/602000.0.0.20231003221203_d4rapt62/sas.finance.fraud.engine.jar</code></pre>

</li>
<li>
<p>Run the following docker command to create a docker image that is used in the init container.</p>
<pre class="highlight"><code class="language-shell">docker build -t &lt;image_name&gt;:&lt;tag&gt; &lt;path_to_Dockerfile_directory&gt;</code></pre>

</li>
<li>
<p>Tag the image and push it to a Docker registry.</p>
<pre class="highlight"><code>docker tag &lt;image_name&gt;:&lt;tag&gt; &lt;repository_url&gt;/&lt;image_name&gt;:&lt;tag&gt;</code></pre>

<p>Replace <image_name>:<tag> with the name and tag of your Docker image, and <repository_url> with the URL of your Docker repository. For example:</p>
<pre class="highlight"><code>docker tag myimage:latest myrepository/myimage:latest</code></pre>

<p>Log in to the Docker registry and push the Docker image to the repository.</p>
<pre class="highlight"><code>docker login &lt;registry_url&gt;

docker push &lt;repository_url&gt;/&lt;image_name&gt;:&lt;tag&gt;</code></pre>

<p>For example:</p>
<pre class="highlight"><code>docker push myrepository/myimage:latest</code></pre>

</li>
<li>
<p>Edit the <code>$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code> file. In the Deployment section, uncomment the init container for &ldquo;fetch-ode-jars&rdquo;, and replace {{ SFM_JAR_IMAGE }} with the URL to the Docker image generated in Step 2. Here is an example:</p>
<pre class="highlight"><code class="language-yaml">initContainers:
- name: fetch-ode-jars
    image: myrepository/myimage:latest
    command: ["sh", "-c"]
    args: ["cp -R /sfmlibs/* /tmp/data"]
    imagePullPolicy: Always
    volumeMounts:
    - name: sfmlibs
        mountPath: "/tmp/data"</code></pre>

</li>
</ol>
<h5 id="140345100038928sas-business-orchestration-worker-container">sas-business-orchestration-worker Container</h5>
<p>The sas-business-orchestration-worker container includes categories of environmental properties. The properties include properties for logging, external services (such as Apache Kafka, Redis and RabbitMQ), processing options, and probe options. Optional security-related properties are covered in the Security section.</p>
<h5 id="140345100038928images">Images</h5>
<p>Update the two image values that are contained in the <code>$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code> file. Revise the value &ldquo;sas-business-orchestration-worker&rdquo; to include the registry server, relative path, name, and tag.  The registry relative server and relative path are the same as other SAS Viya platform deployment images. </p>
<p>The name of the container is &lsquo;sas-business-orchestration-worker&rsquo;. The registry relative path, name, and tag values are found in the sas-components-* configmap in the Viya deployment.</p>
<p>Perform the following commands to determine the appropriate information. When you have the information, add it to the appropriate places in the three files listed above.</p>
<pre class="highlight"><code class="language-shell">$ # generate site.yaml file
$ kustomize build -o site.yaml 

## get the sas-business-orchestration-worker registry information
$ cat manifests.yaml | grep 'sas-business-orchestration-worker:' | grep -v -e "VERSION" -e 'image'

$ # manually update the sas-business-orchestration-worker-example images using the information gathered below: &lt;container registry&gt;/&lt;container relative path&gt;/sas-business-orchestration-worker:&lt;container tag&gt;

$ # apply site.yaml file
$ kustomize apply -f site.yaml </code></pre>

<p>Perform the following commands to get the required information from a running SAS Viya platform deployment.</p>
<pre class="highlight"><code class="language-shell">
# get the registry server, kubectl needs to point to the SAS Viya platform deployment namespace, and replace {{ NAMESPACE }} with the namespace value 
$ kubectl -n {{ NAMESPACE }} get deployment sas-readiness -o yaml | grep -e "image:.*sas-readiness" | sed -e 's/image: //g' -e 's/\/.*//g'  -e 's/^[ \t]*//'
    &lt;container registry&gt; 

# get registry relative path and tag, kubectl needs to point to the SAS Viya platform deployment namespace, and replace {{ NAMESPACE }} with the namespace value
$ CONFIGMAP="$(kubectl -n {{ NAMESPACE }} get cm | grep sas-components | tr -s '' | cut -d ' ' -f1)"
$ kubectl -n {{ NAMESPACE }} get cm "$CONFIGMAP" -o yaml | grep 'sas-business-orchestration-worker:' | grep -v "VERSION"
    SAS_COMPONENT_RELPATH_sas-business-orchestration-worker: &lt;container relative path&gt;/sas-business-orchestration-worker
    SAS_COMPONENT_TAG_sas-business-orchestration-worker: &lt;container tag&gt;</code></pre>

<h5 id="140345100038928logging-properties">Logging Properties</h5>
<p>The SAS_LOG_LEVEL environment variable specifies the minimum severity level for emitting logs. To control the verbosity of the log output, the level can be set to TRACE, DEBUG, INFO, WARN, or ERROR.</p>
<p>The SAS_LOG_FORMAT environment variable specifies the format of the emitted logs. The format can be set to json or plain.</p>
<p>The SAS_LOG_LOCALE environment variable determines which locale messages should be included in the output. The default value is &ldquo;en&rdquo;.</p>
<h5 id="140345100038928external-services-properties">External Services Properties</h5>
<p>External services that are used by a workload require defined properties that are specific to the technology in use. See the comments in the <code>$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml</code> resource file for specific examples.</p>
<h5 id="140345100038928processing-options">Processing Options</h5>
<p>Project yaml files can include multiple workloads that scale independently.  This means that a pod can run only one workload.  Use the WORKLOAD_ENABLED_BY_INDEX environment variable to specify which workload to execute.  If the property is missing the index 0, meaning the first, workload is executed.</p>
<h5 id="140345100038928readiness-probe">Readiness Probe</h5>
<p>The sas-business-orchestration-worker container uses a readiness probe, which allows Kubernetes to determine when a pod is ready to receive data. The initialDelaySeconds field specifies how many seconds Kubernetes should wait before performing the initial probe. The periodSeconds field specifies how many seconds Kubernetes should wait between probes.</p>
<p>For more information about readiness probes, see https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/.</p>
<h5 id="140345100038928sas-business-orchestration-worker-sb-container">sas-business-orchestration-worker-sb Container</h5>
<p>The sas-business-orchestration-worker-sb container includes a Spring Boot application sidecar.  Some orchestration components need to leverage Java libraries to connect to other Java services. This includes SAS Fraud Management engines or when parsing certain SWIFT and ISO standardized message formats is required.  See comments in the resource file for specifics.  This sidecar can be removed or commented out if those JAVA specific implemented features are not needed by the project orchestration workload being executed. </p>
<h4 id="140345100038928section-horizontal-pod-autoscaler">Section - horizontal pod autoscaler</h4>
<p>This section provides an example of a Horizontal Pod Autoscaler.</p>
<h4 id="140345100038928section-openshift-route">Section - OpenShift route</h4>
<p>This section provides an example of an ingress in an OpenShift environment. If you use this ingress, comment out other ingresses in the file.</p>
<h4 id="140345100038928section-ingress">Section - ingress</h4>
<p>This section provides an example of an ingress in an OpenShift environment. If you use this ingress, comment out other ingresses in the file.</p>
<h4 id="140345100038928section-ingress-tls">Section - ingress tls</h4>
<p>This section provides an example of NGINX for HTTP traffic using TLS. If you use this ingress, comment out other ingresses in the file.</p>
<h4 id="140345100038928section-ingress-tls-secret-for-tls-certs-and-keys">Section - ingress tls secret for tls certs and keys</h4>
<p>This section provides an example of a secret that holds TLS certificates and keys.</p>
<h4 id="140345100038928section-secret-for-a-ca-cert-and-key-to-make-a-request-to-sign-a-client-cert-for-two-way-tls">Section - secret for a ca cert and key to make a request to sign a client cert for two-way tls</h4>
<p>This section provides an example of a secret that holds the certificate authority certificate and key that are used for two-way TLS (mTLS).</p>
<h4 id="140345100038928section-create-separate-cert-and-key-for-external-service-such-as-redis-apache-kafka-rabbitmq-etc">Section - create separate cert and key for external service such as Redis, Apache Kafka, Rabbitmq, etc.</h4>
<p>This section provides an example of a secret that holds the certificate authority certificate and key that are used for two-way TLS (mTLS) with external services.</p>
<p>Duplicate this section as needed if multiple external services are used by the orchestration project.</p>
<h3 id="140345100038928services-and-ingresses">Services and Ingresses</h3>
<p>These resources do not require much customization. They require the SUFFIX to be filled in, and the NAMESPACE to be specified, as indicated in the template. The ingresses additionally require the host property be specified. </p>
<p>The services are ClusterIP services, accessed externally via the ingress resources. The ports are already filled in and line up with the prefilled ingress ports. </p>
<p>The ingresses include the host, and rules for directing requests. For the sas-business-orchestration-worker ingress, anything sent with /sas-business-orchestration-worker as the path prefix will use this ingress. The service referenced above uses the ingress in most cases. You might not need ingress if all traffic is within the Kubernetes cluster or if the containers are hosted by another cloud technology.</p>
<h4 id="140345100038928openshift">OpenShift</h4>
<p>If you are deploying your SAS Business Orchestration Worker on OpenShift, you will not be able to use the Ingress resource. In this case, replace your ingress resource with an <a href="#140345100038928section---openshift-route">OpenShift Route</a>.</p>
<h3 id="140345100038928security">Security</h3>
<h4 id="140345100038928tls-secrets">TLS Secrets</h4>
<p>There are optional, commented out sections that may be used to create the secrets containing TLS certificates and keys. The data must be base64 encoded and included in these definitions. These secrets could optionally be created manually via kubectl or kustomize secrets generators. If the secrets are created via some other method, the secret names must still match those referenced in the volumes and ingress definitions. </p>
<h4 id="140345100038928secure-ingress-definition">Secure Ingress Definition</h4>
<p>To add TLS to your ingress, some annotations and spec fields must be added. These will require certificates either included in this template, or created and supplied previously. The template includes a TLS ingress that is commented out, but the below examples break down what is different in this ingress. </p>
<p>To secure your ingress, the following annotations can be used to add one-way TLS, two-way TLS (mTLS), or both.</p>
<pre class="highlight"><code class="language-yaml">annotations:
    # Used to enable TLS
    nginx.ingress.kubernetes.io/auth-tls-secret: {{ NAMESPACE }}/business-orchestration-worker-ingress-tls-ca-config-{{ SUFFIX }}   
    # used to enable mTLS
    nginx.ingress.kubernetes.io/auth-tls-verify-client: "on"    </code></pre>

<p>For one-way TLS, fill in the tls field under the spec field. This also includes a secretName, which includes your TLS certificate.</p>
<pre class="highlight"><code class="language-yaml">tls:
    - hosts:
        - {{ PREFIX }}.{{ INGRESS-TYPE }}.{{ HOST }}
    secretName: business-orchestration-worker-ingress-tls-config-{{ SUFFIX }}</code></pre>

<p>See the resource comments for more specific details.</p>
<h4 id="140345100038928volumes-and-volume-mounts">Volumes and Volume Mounts</h4>
<p>Depending on the security configuration, mounting additional trusted certificates in your containers may be necessary. The areas to add these are tagged with SECURITY, and can be uncommented as necessary. The secret names must match whatever secrets have been configured for these certificates.</p>
<p>There are three volume examples created from secrets containing TLS certificates. One volume example is for sas-business-orchestration-worker certificates, one volume is for an external service certificate. These are defined for each container in the Deployment spec. </p>
<p>After being created, these volumes may be mounted in the sas-business-orchestration-worker container. As defined in the template, the business-orchestration-worker certificates are mounted in /var/run/security, the external service certificates are mounted in /var/run/security/<some external service> which can be duplicated if multiple external services are used by the workload.</p>
<h4 id="140345100038928inline-comments-of-the-deployment-resource">Inline Comments of the Deployment Resource</h4>
<p>Read through all the inline comments of deployment resource.  There is considerable overlap with these instructions here.  However, there are more specifics and a higher degree of detail in the actual deployment resource template.</p>
<h2 id="140345100038928additional-resources">Additional Resources</h2>
<p><a href="https://documentation.sas.com/?cdcId=itopscdc&amp;cdcVersion=default&amp;docsetId=dplyml0phy0dkr&amp;docsetTarget=p127f6y30iimr6n17x2xe9vlt54q.htm">Deploy the software</a>.</p>
<h3 id="140345100038928configure-after-the-initial-deployment">Configure after the Initial Deployment</h3>
<p>Alternatively, SAS Business Orchestration Worker can be installed separately from the SAS Viya platform. Complete steps above, except &ldquo;Deploy the Software&rdquo; in the &ldquo;Additional Resources&rdquo; section. The use case here is to deploy a SAS Business Orchestration Worker project in a Kubernetes namespace that is not a SAS Viya platform deployment.  Instead, perform the following command:</p>
<pre class="highlight"><code class="language-sh">kubectl apply -f "$deploy/site-config/sas-business-orchestration-worker/business-orchestration-worker-deployment.yaml"</code></pre>
    </body>
</html>