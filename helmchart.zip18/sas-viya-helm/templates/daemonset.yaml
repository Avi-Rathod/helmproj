apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "sas-viya-helm.fullname" . }}-workload-orchestrator
  labels:
    app.kubernetes.io/component: sas-workload-orchestrator-daemon
    sas.com/admin: namespace
    sas.com/deployment: sas-viya
    workload.sas.com/class: compute
  {{- include "sas-viya-helm.labels" . | nindent 4 }}
  annotations:
    sas.com/certificate-file-format: pem
    sas.com/component-name: sas-workload-orchestrator
    sas.com/component-version: 1.custom35.custom40-20241115.custom1731693263822
    sas.com/kustomize-base: base
    sas.com/tls-mode: full-stack
    sas.com/version: 1.custom35.custom40
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: sas-workload-orchestrator-daemon
      sas.com/deployment: sas-viya
    {{- include "sas-viya-helm.selectorLabels" . | nindent 6 }}
    matchExpressions: []
  template:
    metadata:
      labels:
        app: sas-workload-orchestrator
        app.kubernetes.io/component: sas-workload-orchestrator-daemon
        app.kubernetes.io/name: sas-workload-orchestrator
        sas.com/deployment: sas-viya
        workload.sas.com/class: compute
      {{- include "sas-viya-helm.selectorLabels" . | nindent 8 }}
      annotations:
        prometheus.io/scheme: https
        sas.com/certificate-file-format: pem
        sas.com/component-name: sas-workload-orchestrator
        sas.com/component-version: 1.custom35.custom40-20241115.custom1731693263822
        sas.com/kustomize-base: base
        sas.com/tls-enabled-ports: all
        sas.com/tls-mode: full-stack
        sas.com/version: 1.custom35.custom40
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: workload.sas.com/class
                operator: In
                values:
                - none
        podAffinity: {}
        podAntiAffinity: {}
      automountServiceAccountToken: true
      containers:
      - env:
        - name: SGMG_MANAGER_HOST
          value: {{ quote .Values.workloadOrchestrator.sasWorkloadOrchestrator.env.sgmgManagerHost
            }}
        - name: SAS_K8S_DEPLOYMENT_NAME
          value: {{ quote .Values.workloadOrchestrator.sasWorkloadOrchestrator.env.sasK8SDeploymentName
            }}
        - name: SGMG_LOGCONFIG_FILE
          value: {{ quote .Values.workloadOrchestrator.sasWorkloadOrchestrator.env.sgmgLogconfigFile
            }}
        - name: SASCLOUDNATIVE
          value: {{ quote .Values.workloadOrchestrator.sasWorkloadOrchestrator.env.sascloudnative
            }}
        - name: POD_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        - name: KUBERNETES_CLUSTER_DOMAIN
          value: {{ quote .Values.kubernetesClusterDomain }}
        envFrom:
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-tls-config-dg85g4hfh8
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-shared-config-c49cg8722d
        - secretRef:
            name: sas-consul-client
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-workload-orchestrator-parameters-862fg2h5h6
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-workload-orchestrator-initial-configuration-2gh6c5dft5
        - secretRef:
            name: sas-workload-orchestrator-passphrase
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-go-config-4m2m8m8662
        image: {{ .Values.workloadOrchestrator.sasWorkloadOrchestrator.image.repository
          }}:{{ .Values.workloadOrchestrator.sasWorkloadOrchestrator.image.tag | default
          .Chart.AppVersion }}
        imagePullPolicy: {{ .Values.workloadOrchestrator.sasWorkloadOrchestrator.imagePullPolicy
          }}
        lifecycle:
          preStop:
            exec:
              command:
              - /opt/sas/viya/config/etc/sgmg/default/sgmgTerm.sh
        name: sas-workload-orchestrator
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /internal/ready
            port: http
            scheme: HTTPS
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 2
        resources: {{- toYaml .Values.workloadOrchestrator.sasWorkloadOrchestrator.resources
          | nindent 10 }}
        securityContext: {{- toYaml .Values.workloadOrchestrator.sasWorkloadOrchestrator.containerSecurityContext
          | nindent 10 }}
        volumeMounts:
        - mountPath: /scripts
          name: scripts
        - mountPath: /opt/sas/viya/config/var/log/sgmg/default
          name: config-var-log
        - mountPath: /opt/sas/viya/config/var/run/sgmg/default
          name: config-var-run
        - mountPath: /tmp
          name: temp-dir
        - mountPath: /security
          name: security
        - mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/cacerts
          name: security
          subPath: cacerts
        - mountPath: /opt/sas/viya/config/etc/SASSecurityCertificateFramework/private
          name: security
          subPath: private
      imagePullSecrets:
      - name: {{ include "sas-viya-helm.fullname" . }}-image-pull-secrets-9dd8hm29fm
      initContainers:
      - env:
        - name: KUBE_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: SAS_CERTFRAME_TOKEN_DIR
          value: {{ quote .Values.workloadOrchestrator.sasCertframe.env.sasCertframeTokenDir
            }}
        - name: SAS_ADDITIONAL_CA_CERTIFICATES_DIR
          value: {{ quote .Values.workloadOrchestrator.sasCertframe.env.sasAdditionalCaCertificatesDir
            }}
        - name: KUBERNETES_CLUSTER_DOMAIN
          value: {{ quote .Values.kubernetesClusterDomain }}
        envFrom:
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-certframe-config-6t84hm65mc
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-certframe-ingress-certificate-config-6mt27h98mb
        - configMapRef:
            name: {{ include "sas-viya-helm.fullname" . }}-certframe-user-config-679cgdbhdt
        image: {{ .Values.workloadOrchestrator.sasCertframe.image.repository }}:{{ .Values.workloadOrchestrator.sasCertframe.image.tag
          | default .Chart.AppVersion }}
        name: sas-certframe
        resources: {{- toYaml .Values.workloadOrchestrator.sasCertframe.resources | nindent
          10 }}
        securityContext: {{- toYaml .Values.workloadOrchestrator.sasCertframe.containerSecurityContext
          | nindent 10 }}
        volumeMounts:
        - mountPath: /certframe-token
          name: certframe-token
        - mountPath: /security
          name: security
        - mountPath: /customer-provided-ca-certificates
          name: customer-provided-ca-certificates
      - env:
        - name: SAS_KEYS_SECRET_NAME
          value: {{ quote .Values.workloadOrchestrator.sasCertframePassphraseGenerator.env.sasKeysSecretName
            }}
        - name: SAS_KEYS_KEY_NAMES
          value: {{ quote .Values.workloadOrchestrator.sasCertframePassphraseGenerator.env.sasKeysKeyNames
            }}
        - name: SAS_SECURITY_ARTIFACTS_DIR
          value: {{ quote .Values.workloadOrchestrator.sasCertframePassphraseGenerator.env.sasSecurityArtifactsDir
            }}
        - name: KUBERNETES_CLUSTER_DOMAIN
          value: {{ quote .Values.kubernetesClusterDomain }}
        image: {{ .Values.workloadOrchestrator.sasCertframePassphraseGenerator.image.repository
          }}:{{ .Values.workloadOrchestrator.sasCertframePassphraseGenerator.image.tag |
          default .Chart.AppVersion }}
        name: sas-certframe-passphrase-generator
        resources: {{- toYaml .Values.workloadOrchestrator.sasCertframePassphraseGenerator.resources
          | nindent 10 }}
        securityContext: {{- toYaml .Values.workloadOrchestrator.sasCertframePassphraseGenerator.containerSecurityContext
          | nindent 10 }}
        volumeMounts:
        - mountPath: /security
          name: security
      securityContext: {{- toYaml .Values.workloadOrchestrator.podSecurityContext | nindent
        8 }}
      serviceAccountName: {{ include "sas-viya-helm.fullname" . }}-workload-orchestrator
      terminationGracePeriodSeconds: 60
      tolerations:
      - effect: NoSchedule
        key: workload.sas.com/class
        operator: Equal
        value: compute
      volumes:
      - emptyDir: {}
        name: scripts
      - emptyDir: {}
        name: security
      - emptyDir: {}
        name: config-var-log
      - emptyDir: {}
        name: config-var-run
      - emptyDir: {}
        name: temp-dir
      - name: certframe-token
        secret:
          secretName: {{ include "sas-viya-helm.fullname" . }}-certframe-token
      - configMap:
          name: {{ include "sas-viya-helm.fullname" . }}-customer-provided-ca-certificates-bm5hc686c7
        name: customer-provided-ca-certificates
